---
title: 缓存
categories:
tags:
---

## 什么是缓存，为什么需要用缓存

缓存就是数据交换的缓冲区（称作 Cache），是存贮数据（使用频繁的数据）的临时地方。当用户查询数据，首先在缓存中寻找，如果找到了则直接执行。如果找不到，则去数据库中查找。

缓存的本质就是用空间换时间，牺牲数据的实时性，以服务器内存中的数据暂时代替从数据库读取最新的数据，减少数据库 IO，减轻服务器压力，减少网络延迟，加快页面打开速度。

## 哪些缓存

浏览器缓存：浏览器缓存根据一套与服务器约定的规则进行工作，在同一个会话过程中会检查一次并确定缓存的副本足够新。如果在浏览过程中前进或后退时访问到同一个图片，这些图片可以从浏览器缓存中调出而即时显示。

数据库缓存：常用的缓存方案有 memcached、redis 等。把经常需要从数据库查询的数据、或经常更新的数据放入到缓存中，这样下次查询时，直接从缓存直接返回，减轻数据库压力，提升数据库性能。

Web 应用层缓存:应用层缓存指的是从代码层面上，通过代码逻辑和缓存策略，实现对数据、页面、图片等资源的缓存，可以根据实际情况选择将数据存在文件系统或者内存中，减少数据库查询或者读写瓶颈，提高响应效率。

服务器缓存：包括代理服务器缓存和 CDN 缓存。

代理服务器缓存：代理服务器是浏览器和源服务器之间的中间服务器，浏览器先向这个中间服务器发起 Web 请求，经过处理后(比如权限验证，缓存匹配等)，再将请求转发到源服务器。
代理服务器缓存的运作原理跟浏览器的运作原理差不多，只是规模更大。可以把它理解为一个共享缓存，不只为一个用户服务，一般为大量用户提供服务，因此在减少响应时间和带宽使用方面很有效，同一个副本会被重用多次。

CDN 缓存：也叫网关缓存、反向代理缓存。CDN 缓存一般是由网站管理员自己部署，为了让他们的网站更容易扩展并获得更好的性能。
浏览器先向 CDN 网关发起 Web 请求，网关服务器后面对应着一台或多台负载均衡源服务器，会根据它们的负载请求，动态将请求转发到合适的源服务器上。
虽然这种架构负载均衡源服务器之间的缓存没法共享，但却拥有更好的处扩展性。从浏览器角度来看，整个 CDN 就是一个源服务器。

## 强缓存

http1.0：

expires: 值为相对时间，相对服务器时间，不同地区服务器时间不一致，会出错

http1.1：
cache-control:12312 ，时间为时间戳(秒)，相对第一次加载的时间。

public no-cache

## 弱缓存

http1.0:

modified: 文件被修改的时间
if-modified-since：如果请求时，response 中 header 上存在 modified，则第二次请求的时候会带上 if-modified-since，如果服务器文件的修改的时间大于 if-modified-since 的值，则会返回新的文件，否则告诉浏览器去缓存里面获取

http1.1:

etag：一串字符串
if-none-match: 如果第一个请求，response 的 header 上存在 etag,则第二次请求时，会带上 if-none-match，值为 etag 的值，如果服务器文件的 etag 和 if-none-match 值是否一致，一致返回最新的文件，否则告诉浏览器去缓存里面获取

## 强缓存和弱缓存

expires 和 cache-control 同时存在时，cache-control 优先级更高，expires 可以兼容一些旧

## chrome firefox 304

协商缓存就是强制缓存失效后，浏览器携带缓存标识向服务器发起请求，由服务器根据缓存标识决定是否使用缓存的过程

304: 当服务器判断 if-modifined-since 和 if-none-match

firefox 都是 304
chrome 直接获取缓存里面的

## 用户行为对浏览器缓存的控制

地址栏访问，链接跳转是正常用户行为，将会触发浏览器缓存机制；
F5 刷新，浏览器会设置 max-age=0，跳过强缓存判断，会进行协商缓存判断；
ctrl+F5 刷新，跳过强缓存和协商缓存，直接从服务器拉取资源。

## 相关阅读

[缓存](https://www.jiqizhixin.com/articles/2020-07-24-12)
[缓存](https://www.jianshu.com/p/54cc04190252)
