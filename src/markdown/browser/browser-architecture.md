---
title: 浏览器架构
categories:
  - 前端
tags:
  - 浏览器
date: 2020-06-05 15:33:33
---

## 进程（process）和线程（thread）和协程

进程：cpu 资源分配的最小单位
线程：cpu 调度的最小单位
协程:

[协程](https://www.liaoxuefeng.com/wiki/897692888725344/923057403198272)

## 单核 CPU 和多核 CPU

## 并发和并行

## 浏览器简介

目前使用的主流浏览器有五个：Internet Explorer、Firefox、Safari、Chrome 浏览器和 Opera

浏览器的主要功能就是向服务器发出请求，在浏览器窗口中展示您选择的网络资源。这里所说的资源一般是指 HTML 文档，也可以是 PDF、图片或其他的类型。资源的位置由用户使用 URI（统一资源标示符）指定。

浏览器解释并显示 HTML 文件的方式是在 HTML 和 CSS 规范中指定的。这些规范由网络标准化组织 W3C（万维网联盟）进行维护

## 浏览器构成

**七个部分构成：**

![浏览器组成](https://waqll.oss-cn-qingdao.aliyuncs.com/blog/browser.png)

- **用户界面 （User Interface）**
  包括地址栏、前进/后退按钮、书签菜单等。除了浏览器主窗口显示的您请求的页面外，其他显示的各个部分都属于用户界面
  用户界面主要包括工具栏、地址栏、前进/后退按钮、书签菜单、可视化页面加载进度、智能下载处理、首选项、打印等。除了浏览器主窗口显示请求的页面之外，其他显示的部分都属于用户界面。
  用户界面还可以与桌面环境集成，以提供浏览器会话管理或与其他桌面应用程序的通信。

- **浏览器引擎 （Browser engine）**
  在用户界面和呈现引擎之间传送指令
  浏览器引擎是一个可嵌入的组件，其为渲染引擎提供高级接口。
  浏览器引擎可以加载一个给定的 URI，并支持诸如：前进/后退/重新加载等浏览操作。
  浏览器引擎提供查看浏览会话的各个方面的挂钩，例如：当前页面加载进度、JavaScript alert。
  浏览器引擎还允许查询/修改渲染引擎设置。
- **渲染引擎 （Rendering engine）**
  负责显示请求的内容。如果请求的内容是 HTML，它就负责解析 HTML 和 CSS 内容，并将解析后的内容显示在屏幕上
  渲染引擎为指定的 URI 生成可视化的表示。
  渲染引擎能够显示 HTML 和 XML 文档，可选择 CSS 样式，以及嵌入式内容（如图片）。
  渲染引擎能够准确计算页面布局，可使用“回流”算法逐步调整页面元素的位置。
  渲染引擎内部包含 HTML 解析器。
- **网络 （Networking）**
  用于网络调用，比如 HTTP 请求。其接口与平台无关，并为所有平台提供底层实现。
  网络系统实现 HTTP 和 FTP 等文件传输协议。 网络系统可以在不同的字符集之间进行转换，为文件解析 MIME 媒体类型。 网络系统可以实现最近检索资源的缓存功能。
- **JavaScript 解释器 （Javascript interpreter）**
  用于解析和执行 JavaScript 代码
  JavaScript 解释器能够解释并执行嵌入在网页中的 JavaScript（又称 ECMAScript）代码。 为了安全起见，浏览器引擎或渲染引擎可能会禁用某些 JavaScript 功能，如弹出窗口的打开。
- **用户界面后端（UI Backend）**
  用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台无关的通用接口，而在底层使用操作系统的用户界面方法。
  显示后端提供绘图和窗口原语，包括：用户界面控件集合、字体集合。
- **数据存储 （Data Persistence）**
  这是持久层。浏览器需要在硬盘上保存各种数据，例如 Cookie。新的 HTML 规范 (HTML5) 定义了“网络数据库”，这是一个完整（但是轻便）的浏览器内数据库。

数据持久层将与浏览会话相关联的各种数据存储在硬盘上。 这些数据可能是诸如：书签、工具栏设置等这样的高级数据，也可能是诸如：Cookie，安全证书、缓存等这样的低级数据。

## 浏览器进程

- 浏览器是多进程的
- 浏览器之所以能够运行，是因为系统给它的进程分配了资源（cpu、内存）
- 简单点理解，每打开一个 Tab 页，就相当于创建了一个独立的浏览器进程

最新的 Chrome 浏览器包括：1 个浏览器（Browser）主进程、1 个 GPU 进程、1 个网络（NetWork）进程、多个渲染进程和多个插件进程。

1. Browser 进程：浏览器的主进程（负责协调、主控），只有一个。作用有

   - 负责浏览器界面显示，与用户交互。如前进，后退等
   - 负责各个页面的管理，创建和销毁其他进程
   - 将 Renderer 进程得到的内存中的 Bitmap，绘制到用户界面上
   - 网络资源的管理，下载等

2. 第三方插件进程：每种类型的插件对应一个进程，仅当使用该插件时才创建

3. GPU 进程：最多一个，用于 3D 绘制等

4. 浏览器渲染进程（浏览器内核）（Renderer 进程，内部是多线程的）：默认每个 Tab 页面一个进程，互不影响。主要作用为：

   - 页面渲染，脚本执行，事件处理等

5. 网络进程

**_在浏览器中打开一个网页相当于新起了一个进程（进程内有自己的多线程）,打开多个空白标签页后，会发现多个空白标签页被合并成了一个进程_**

## 浏览器渲染进程（内核）

浏览器的内核是分为两个部分的，一是渲染引擎，另一个是 JS 引擎。
现在 JS 引擎比较独立，内核更加倾向于说渲染引擎。

**常见的浏览器内核五种：**

1. **Trident 内核：** 代表作品是 IE，因 IE 捆绑在 Windows 中，所以占有极高的份额，又称为 IE 内核或 MSHTML，此内核只能用于 Windows 平台，且不是开源的。
   代表作品还有腾讯、Maxthon（遨游）、360 浏览器等。但由于市场份额比较大，曾经出现脱离了 W3C 标准的时候，同时 IE 版本比较多，存在很多的兼容性问题。

2. **Gecko 内核：** 代表作品是 Firefox，即火狐浏览器。因火狐是最多的用户，故常被称为 firefox 内核它是开源的，最大优势是跨平台，在 Microsoft Windows、Linux、MacOs X 等主要操作系统中使用。Mozilla 是网景公司在第一次浏览器大战败给微软之后创建的。有兴趣的同学可以了解一下浏览器大战

3. **Webkit 内核：** 代表作品是 Safari、曾经的 Chrome，是开源的项目。

4. **Presto 内核：** 代表作品是 Opera，Presto 是由 Opera Software 开发的浏览器排版引擎，它是世界公认最快的渲染速度的引擎。在 13 年之后，Opera 宣布加入谷歌阵营，弃用了 Presto

5. **Blink 内核：** 由 Google 和 Opera Software 开发的浏览器排版引擎，2013 年 4 月发布。现在 Chrome 内核是 Blink。谷歌还开发了自己的 JS 引擎，V8，使 JS 运行速度极大地提高了

<!-- [原文链接](https://blog.csdn.net/u014753892/article/details/52713841) -->

**浏览器 JS 引擎：**

1. Mozilla: SpiderMonkey、TraceMonkey、JagerMonkey、Rhino
2. Google: V8
3. Microsoft: chakra、JScript
4. Opera: Carakan
5. Apple: javaScriptCore
6. 其他: KJS、Narcissus、Tamarin、Nitro

最近发布 QuickJS 与 Hermes 也是 JS 引擎，它们都超越了浏览器范畴.

## 渲染进程的线程

可以这样理解，页面的渲染，JS 的执行，事件的循环，都在这个进程内进行。

**渲染进程是多线程的，有五个线程构成：**

1. GUI 渲染线程

   - 负责渲染浏览器界面，解析 HTML，CSS，构建 DOM 树和 RenderObject 树，布局和绘制等。
   - 当界面需要重绘（Repaint）或由于某种操作引发回流(reflow)时，该线程就会执行
   - 注意，GUI 渲染线程与 JS 引擎线程是互斥的，当 JS 引擎执行时 GUI 线程会被挂起（相当于被冻结了），GUI 更新会被保存在一个队列中等到 JS 引擎空闲时立即执行。

2. JS 引擎线程

   - 也称为 JS 内核，负责处理 Javascript 脚本程序。（例如 V8 引擎）
   - JS 引擎线程负责解析 Javascript 脚本，运行代码。
   - JS 引擎一直等待着任务队列中任务的到来，然后加以处理，一个 Tab 页（renderer 进程）中无论什么时候都只有一个 JS 线程在运行 JS 程序
   - 同样注意，GUI 渲染线程与 JS 引擎线程是互斥的，所以如果 JS 执行的时间过长，这样就会造成页面的渲染不连贯，导致页面渲染加载阻塞。

3. 事件触发线程

   - 归属于浏览器而不是 JS 引擎，用来控制事件循环（可以理解，JS 引擎自己都忙不过来，需要浏览器另开线程协助）
   - 当 JS 引擎执行代码块如 setTimeOut 时（也可来自浏览器内核的其他线程,如鼠标点击、AJAX 异步请求等），会将对应任务添加到事件线程中
   - 当对应的事件符合触发条件被触发时，该线程会把事件添加到待处理队列的队尾，等待 JS 引擎的处理
   - 注意，由于 JS 的单线程关系，所以这些待处理队列中的事件都得排队等待 JS 引擎处理（当 JS 引擎空闲时才会去执行）

4. 定时触发器线程

   - 传说中的 setInterval 与 setTimeout 所在线程
   - 浏览器定时计数器并不是由 JavaScript 引擎计数的,（因为 JavaScript 引擎是单线程的, 如果处于阻塞线程状态就会影响记计时的准确）
   - 因此通过单独线程来计时并触发定时（计时完毕后，添加到事件队列中，等待 JS 引擎空闲后执行）
   - 注意，W3C 在 HTML 标准中规定，规定要求 setTimeout 中低于 4ms 的时间间隔算为 4ms。

5. 异步 http 请求线程

   - 在 XMLHttpRequest 在连接后是通过浏览器新开一个线程请求
   - 将检测到状态变更时，如果设置有回调函数，异步线程就产生状态变更事件，将这个回调再放入事件队列中。再由 JavaScript 引擎执行。

## Chrome devtool

Elements: 查看 dom 结构，编辑 css 样式，用于测试页面布局和设计页面
Console: 可以看成是 Javascript shell，能执行 javascript 脚本，通过 console 还能和页面中的 javascript 对象交互
Sources: 1、查看 Web 应用加载的所有文件 2、编辑 css 和 javascript 文件内容 3、将打乱的 css 文件或者 javascript 文件格式化，4、 支持 javascript 的调试功能 5、设置工作区，将更改的文件保存到本地文件夹

## 如何理解 js 是单线程的

## 相关阅读

[浏览器进程](https://juejin.im/post/5a6547d0f265da3e283a1df7)
[浏览器架构](https://xie.infoq.cn/article/5d36d123bfd1c56688e125ad3)
[浏览器渲染进程](https://zhuanlan.51cto.com/art/201810/585450.htm)
[渲染](https://juejin.cn/post/6844903476506394638)
[navigator](https://stackoverflow.com/questions/14573881/why-does-javascript-navigator-appname-return-netscape-for-safari-firefox-and-ch)
